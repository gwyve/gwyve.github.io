<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>读文笔记Faster R-CNN | gwyve</title>
    <meta name="author" content="Gwyve" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="VE's Blog" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta property="wb:webmaster" content="ddb1e697310369c4" />
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>

    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">gwyve</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/3225437531/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/blog/2017/01/05/reading-note-Faster-R-CNN.html" title="读文笔记Faster R-CNN">读文笔记Faster R-CNN</a></h1>
        <p class="entry-date">2017-01-05</p>
        <p>声明：本博客欢迎转发，但请保留原作者信息!    <br />
作者：高伟毅  <br />
博客：<a href="https://gwyve.github.io/">https://gwyve.github.io/</a>  <br />
微博：<a href="http://weibo.com/u/3225437531/">http://weibo.com/u/3225437531/</a></p>

<h2 id="引言">引言</h2>
<p>这是在Fast R-CNN之后的一篇文章，推荐阅读Fast R-CNN之后再阅读这篇文章。</p>

<h2 id="发表位置">发表位置</h2>
<ul>
  <li>NIPS 2015</li>
  <li><a href="https://arxiv.org/pdf/1506.01497v3.pdf">PDF.v3</a></li>
</ul>

<h2 id="问题引入">问题引入</h2>
<p>整篇文章，只是说明了一件事，就是之前的fast R-CNN中，在进入RoI pooling层之前的推荐区域是通过SS（Selective Search）产生的。SS在产生推荐区域的这个过程花费时间太多。作者引入了RPN（Region Proposal Networks）这个模型方法来替代SS，节省时间。也可以说，Faster R-CNN = RPN + FRCN。</p>

<h2 id="faster-r-cnn结构和训练过程">Faster R-CNN结构和训练过程</h2>

<ol>
  <li>整张图片输入Conv层生成Feature map</li>
  <li>把Feature Map输入RPN生成一个要推荐区域的位置坐标</li>
  <li>根据步骤2推荐出的区域坐标，把Feature map中相应的区域输入RoI pooling层，生成固定长度的向量。</li>
  <li>第3步产生的固定长度向量输入全连接（fc）层，fc层分成两个sibling output layer：一个生成K+1个类的softmax，另一个生成bounding-position的位置。（与我之前说的FRCN的第四步一样的）</li>
</ol>

<p><img src="/images/blog/2017-1-5/architecture.png" alt="architecture" /></p>

<p>这个意思就是在Fast R-CNN之前不再使用SS，而加上RPN生成Proposals。</p>

<p>我根据作者的想法，我画了一个流程，不过有个地方没有没有画明白。</p>

<p><img src="/images/blog/2017-1-5/architecture_ve.png" alt="architecture_ve" /></p>

<p><strong>这里，Proposal并不是直接输入到RoI Pooling层，而是根据这个Proposal产生的坐标，或者说是个框框，在Feature Map找出相应的区域，把这个Feature Map中的这一块输入到RoI Pooling层。</strong></p>

<h2 id="rpnregion-proposal-networks">RPN：Region Proposal Networks</h2>

<h3 id="rpn-结构">RPN 结构</h3>
<p><img src="/images/blog/2017-1-5/RPN_architecture.png" alt="RPN_architecture" /></p>

<p>在Feature map上有一个n×n的滑窗（文章中用n=3），这个滑窗是一个n×n的convolutional layer，如果用
ZF模型，则通过该滑窗生成256维的向量。这个向量分别通过两个1×1的convolutional layer，生成一个是否有object的分数和这个框框的位置。生成的这两个量并非跟真正的作对比，而是跟一个被称为Anchors的东西作对比。</p>

<h3 id="anchors">Anchors</h3>
<p>在文章中，作者是这么说的“The k proposals are parameterizedrelative to k reference boxes, which we call anchors.”作者还提到是不同的scale和长宽比（本文中用到了分别是（128<sup>2</sup>,256<sup>2</sup>,512<sup>2</sup>）（2:1,1:1,2:1），一共是九种anchors）。</p>

<p>这个Anchor是在滑窗当前位置下，以当前窗为中心，变动的一个区域。这个Anchor具体如何用，在接下来的损失函数讲。</p>

<h3 id="损失函数">损失函数</h3>
<p><img src="/images/blog/2017-1-5/loss_function1.png" alt="loss_fucntion" />   <br />
具体过程：</p>
<ol>
  <li>给anchor标一个分数： 与真实的框框IoU最高的标为正数；与真实的框框IoU超过0.7的标为正数；与真实框框IoU小于0.3的标为负数。</li>
  <li>Pi<sup>*</sup>是anchor在步骤1中标的值。</li>
  <li>这个t表示的是预测出的框框位置，t<sup>*</sup>表示Anchor的位置，具体如图                 <br />
<img src="/images/blog/2017-1-5/loss_function2.png" alt="loss_fucntion2" />    <br />
<strong>到这里我才能明白Anchor是干啥用的，就是用来在真实框框跟预测框框之间的一个东西，仔细想想叫做“锚”这个词还是有道理的。</strong></li>
</ol>

<h3 id="faster-r-cnn-训练过程">Faster R-CNN 训练过程</h3>

<p>4步交替训练</p>
<ol>
  <li>不管Fast R-CNN，只是训练RPN。</li>
  <li>不改变RPN，只是使用RPN输入的框框训练Fast R-CNN。</li>
  <li>用Fast R-CNN初始化RPN，不改变Convolutional layers，只是微调RPN。</li>
  <li>不改变Convolutional layers，微调Fast R-CNN。</li>
</ol>

<h2 id="实验各种测评">实验、各种测评</h2>

<h3 id="map">mAP</h3>

<p><img src="/images/blog/2017-1-5/experiment1.png" alt="experiment1" /></p>

<p>这个是PASCAL VOC 2007的结果，在具体实现的时候，使用了RPN推荐的区域里面排名前300的区域（这样做是否有道理，后面会实验证明）。</p>

<p>ablation experiments的第一个为了证明，RPN与fast R-CNN共享卷积层有用。第二个为了证明，使用推荐区域的前多少个合适。第三、四为了证明cls、reg两层有用。</p>

<h3 id="时间">时间</h3>

<p><img src="/images/blog/2017-1-5/experiment2.png" alt="experiment_time" /></p>

<p>可以看出，在conv层的耗时基本差不多，在选择推荐区域的时候RPN比SS更省时间，在“Region-wise”上Faster R-CNN更省时间（只输入推荐区域的一部分，数据少了，时间必然少了）。总之，整个目标发现系统使用的时间少了。</p>

<h3 id="anchor--λ">Anchor &amp;&amp; λ</h3>
<p>就是选择具体参数的问题</p>

<p><img src="/images/blog/2017-1-5/experiment3.png" alt="experiment3" /></p>

<h3 id="analysis-of-recall-to-iou">Analysis of Recall-to-IoU</h3>

<p>这一部分也说明了RPN可以使用推荐的top-300这个方法。作者原话“ The plots show that the RPN method behaves gracefully when the number of proposals drops from 2000 to 300. This explains why the RPN has a good ultimate detection mAP when using as few as 300 proposals.”</p>

<h3 id="one-stage-detection-vs-two-stage-proposal--detection">One-Stage Detection vs. Two-Stage Proposal + Detection</h3>

<p><img src="/images/blog/2017-1-5/experiment4.png" alt="one vs two" /></p>

<p>这个主要证明了，RPN只是判定区域里面有没有对象，没有判断里面的对象的分类，这件事是有作用的。</p>

<h2 id="个人总结">个人总结</h2>

<p>我觉得这个Faster R-CNN主要贡献就是RPN</p>

<h3 id="提升准确率的">提升准确率的</h3>
<ul>
  <li>RPN和Fast R-CNN共享Conv layers</li>
  <li>Anchor的存在，尺度上不必有变化</li>
</ul>

<h3 id="提升速度的">提升速度的</h3>
<ul>
  <li>RPN没有之前的那种滑动窗口或者过滤器，Anchor的使用。</li>
  <li>RPN没有像SS推荐的那么多的区域。</li>
  <li>RPN推荐的区域，可以使用排名靠前的一部分，而不是全部。</li>
</ul>

<h2 id="个人想法">个人想法</h2>
<p>有的几个地方，还是不太懂，比如在第一个alation experiments的时候，为什么训练的时候用SS；One-Stage Detection vs Two-Stage Proposal + Detection这一部分，为什么这么设计实验？</p>

<p>我觉得这些问题可以等等看的论文多了，抑或看看Faster R-CNN的代码了，会有更好的理解。</p>



        <div id="disqus_container">
            <div style="margin-bottom:20px" class="right">
                <script type="text/javascript" charset="utf-8">
                (function(){
                  var _w = 86 , _h = 16;
                  var param = {
                    url:location.href,
                    type:'6',
                    count:'', /**是否显示分享数，1显示(可选)*/
                    appkey:'', /**您申请的应用appkey,显示分享来源(可选)*/
                    title:'', /**分享的文字内容(可选，默认为所在页面的title)*/
                    pic:'', /**分享图片的路径(可选)*/
                    ralateUid:'3225437531', /**关联用户的UID，分享微博会@该用户(可选)*/
                    language:'zh_cn', /**设置语言，zh_cn|zh_tw(可选)*/
                    rnd:new Date().valueOf()
                  }
                  var temp = [];
                  for( var p in param ){
                    temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
                  }
                  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="https://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'"></iframe>')
                })()
                </script>
            </div>
<!--
            <a href="#" class="comment" onclick="return false;">点击查看评论</a>
-->
            <div id="disqus_thread"></div>
        </div>
    </div>

    <div class="sidenav">
        <iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="https://widget.weibo.com/weiboshow/index.php?language=&width=0&height=75&fansRow=2&ptype=1&speed=0&skin=5&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=3225437531&verifier=87199cd9&dpc=1"></iframe>
    </div>



    <div class="sidenav">
        <h2>Blog</h2>
        <ul class="artical-list">
        
            <li><a href="/blog/2017/07/16/reading-note-the-truth-about-self-driving-cars.html">读文笔记 The Truth About "self-driving" Cars</a></li>
        
            <li><a href="/blog/2017/05/17/reading-note-A-Fast-RCNN.html">读文笔记A-Fast-RCNN</a></li>
        
            <li><a href="/blog/2017/05/02/double-power.html">双电源供电</a></li>
        
            <li><a href="/blog/2017/04/11/reading-note-FPN.html">读文笔记FPN</a></li>
        
            <li><a href="/blog/2017/04/10/reading-note-Speed-Accuracy.html">读文笔记Speed/Accuracy trade-offs</a></li>
        
            <li><a href="/blog/2017/03/29/reading-note-R-FCN.html">读文笔记R-FCN</a></li>
        
            <li><a href="/blog/2017/03/27/caffe-add-layer.html">caffe添加新layer</a></li>
        
            <li><a href="/blog/2017/03/20/reading-note-ResNet.html">读文笔记ResNet</a></li>
        
            <li><a href="/blog/2017/03/01/reading-note-SSD.html">读文笔记SSD</a></li>
        
            <li><a href="/blog/2017/02/24/reading-note-DeepMultiBox.html">读文笔记DeepMultiBox</a></li>
        
            <li><a href="/blog/2017/02/15/reading-note-YOLO.html">读文笔记YOLO</a></li>
        
            <li><a href="/blog/2017/01/05/reading-note-Faster-R-CNN.html">读文笔记Faster R-CNN</a></li>
        
            <li><a href="/blog/2016/12/28/reading-note-Fast-R-CNN.html">读文笔记Fast R-CNN</a></li>
        
            <li><a href="/blog/2016/12/23/reading-note-sppnet.html">读文笔记SPPnet</a></li>
        
            <li><a href="/blog/2016/12/11/who-i-am.html">我是谁</a></li>
        
        </ul>
<!--
        <h2>Opinion</h2>
        <ul class="artical-list">
        
        </ul>
-->
        <h2>Project</h2>
        <ul class="artical-list">
        
            <li><a href="/project/2017/03/25/ServerOnAndroid.html">ServerOnAndroid</a></li>
        
            <li><a href="/project/2017/03/05/cuda-tensorflow-install.html">cuda && tensorflow 安装</a></li>
        
            <li><a href="/project/2016/12/19/LuceneForAndroid.html">LuceneForAndroid</a></li>
        
        </ul>
    </div>
</div>

<script src="/js/post.js" type="text/javascript"></script>


    <script type="text/javascript">
        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })
    </script>
</body>
</html>
